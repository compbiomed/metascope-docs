<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="MetaScope">
<title>Introduction to MetaScope • MetaScope</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Introduction to MetaScope">
<meta property="og:description" content="MetaScope">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">MetaScope</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.99</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../index.html">Home</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../articles/MetaScope_vignette.html">Tutorial</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Function Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">Package News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/compbiomed/MetaScope">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Introduction to MetaScope</h1>
                        <h4 data-toc-skip class="author">Aubrey Odom</h4>
            <address class="author_afil">
      Program in Bioinformatics, Boston University, Boston, MA<br><a class="author_email" href="mailto:#"></a><a href="mailto:aodom@bu.edu" class="email">aodom@bu.edu</a>
      </address>
                              <h4 data-toc-skip class="author">W. Evan Johnson</h4>
            <address class="author_afil">
      The Section of Computational Biomedicine, Boston University School of Medicine, Boston, MA<br><a class="author_email" href="mailto:#"></a><a href="mailto:wej@bu.edu" class="email">wej@bu.edu</a>
      </address>
                  
            <h4 data-toc-skip class="date">March 11, 2022</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/compbiomed/MetaScope/blob/HEAD/vignettes/rmd/oldMetascope_vignette.Rmd" class="external-link"><code>vignettes/rmd/oldMetascope_vignette.Rmd</code></a></small>
      <div class="d-none name"><code>oldMetascope_vignette.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>When utilizing the MetaScope package, keep in mind that many (if not all) functions output the name of a .bam file or other file(s) that are written automatically to the user’s working directory. As such, it is vital that the user selects a working directory that can store all intermediate and final files prior to beginning any of the MetaScope workflows.</p>
<p>This vignette analyses raw sequencing data obtained from the NCBI Sequence Read Archive (SRA), a public repository of high throughput sequencing data. The sample used for all workflow examples, except the demultiplexing workflow, is from a diverse bacterial and archaeal synthetic community assembled from pure genomic DNAs, made available under accession number <a href="https://www.ncbi.nlm.nih.gov/sra/SRX200715%5Baccn%5D" class="external-link">SRX200715</a> from Oak Ridge National Laboratories. Throughout the examples presented here, we assume that we are interested in the viral material present in the sample, and that we wish to exclude any reads mapping to archael genomes. For the sake of example, we do not run the code in this vignette as the functions are mostly used for writing files to an external directory, with supplemental updates in the terminal output. However, the vignette code can be run outside of the vignette by referencing the FASTQ file path with the following line of code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">readPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"SRR606366.fastq"</span>, package <span class="op">=</span> <span class="st">"MetaScope"</span><span class="op">)</span>

<span class="va">readPath</span></code></pre></div>
<pre><code><span class="co">## [1] ""</span></code></pre>
</div>
<div class="section level3">
<h3 id="reference-genome-library">Reference Genome Library<a class="anchor" aria-label="anchor" href="#reference-genome-library"></a>
</h3>
<p>The MetaScope genome library workflow is designed to assist with collection of sequence data from the National Center for Biotechnology Information (NCBI) database. Prior to doing so, the potential targets and filters for the analysis should be identified. That is, what “target” species do you expect to find in your metagenomic sample that you would like to identify, and what reads would you like to “filter” out from the data that are not essential to your analysis?</p>
<p>Typically, the targets of the analysis are microbes (that is, viruses, bacteria, and fungi), and we wish to filter out or discard any reads from the host in addition to artificially added sequences, such as PhiX174. Following identification of the targets and filters, we use a reference genome library to realign the vast number of sample reads back to the respective regions of origin in various species.</p>
<p>The <code><a href="../../reference/download_refseq.html">download_refseq()</a></code> function automatically extracts custom reference genome libraries in a FASTA file for microbial or host genomes. The user must first indicate a taxon for which to download the genomes, such as ‘bacteria’ or ‘Primates’. A table of possible entries be viewed by accessing the <code>taxonomy_table</code> obeject. They may then specify whether they wish to download only the RefSeq reference genomes, or both the reference and representative genomes. The compress option then allows users to specify whether to compress the output FASTA file; this is done by default.</p>
<p>In the following code, we download only the viral reference genomes from the NCBI database, in an uncompressed FASTA format.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Code block not run</span>

<span class="fu"><a href="../../reference/download_refseq.html">download_refseq</a></span><span class="op">(</span><span class="st">'viral'</span>, compress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>We will also download appropriate material from the NCBI database to create a filter library for archaeal genomes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Code block not run</span>

<span class="co"># Representative MUST be set to TRUE for the archaea library</span>
<span class="fu"><a href="../../reference/download_refseq.html">download_refseq</a></span><span class="op">(</span><span class="st">'archaea'</span>, compress <span class="op">=</span> <span class="cn">FALSE</span>, representative <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="demultiplex">Demultiplex<a class="anchor" aria-label="anchor" href="#demultiplex"></a>
</h3>
<p>Sequence runs on NGS instruments are typically carried out with multiple samples pooled together. An index tag (also called a barcode) consisting of a unique sequence of between 6 and 12bp is added to each sample so that the sequence reads from different samples can be identified. For 16s experiments or sequencing conducted using an Illumina machine, the process of demultiplexing (dividing your sequence reads into separate files for each index tag/sample) and generating the fastq data files required for downstream analysis can be done using the MetaScope demultiplexing workflow. This consists of the <code><a href="../../reference/demultiplex.html">demultiplex()</a></code> function, which takes as arguments a matrix of sample names/barcodes, a FASTQ file of barcodes by sequence header, and a FASTQ file of reads corresponding to the barcodes. Based on the barcodes given, the function extracts all reads for the indexed barcode and writes all the reads from that barcode to separate FASTQ files.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Code block not run</span>

<span class="co"># Get barcode, index, and read data locations</span>
<span class="va">barcodePath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"barcodes.txt"</span>, package <span class="op">=</span> <span class="st">"MetaScope"</span><span class="op">)</span>
<span class="va">indexPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"virus_example_index.fastq"</span>,
                         package <span class="op">=</span> <span class="st">"MetaScope"</span><span class="op">)</span>
<span class="va">readPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"virus_example.fastq"</span>, package <span class="op">=</span> <span class="st">"MetaScope"</span><span class="op">)</span>

<span class="co"># Get barcode, index, and read data locations</span>
<span class="va">demult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/demultiplex.html">demultiplex</a></span><span class="op">(</span><span class="va">barcodePath</span>, <span class="va">indexPath</span>, <span class="va">readPath</span>, rcBarcodes <span class="op">=</span> <span class="cn">FALSE</span>,
                      hammingDist <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="alignment-with-reference-libraries">Alignment with Reference Libraries<a class="anchor" aria-label="anchor" href="#alignment-with-reference-libraries"></a>
</h3>
<p>After acquiring the target and filtering genome libraries, we may then take the sequencing reads from our sample and map them first to a target library, and then to the filter library. MetaScope’s mapping module utilizes the Subread aligner (Liao 2013) which maps reads to a reference genome via an efficient and simple seed-and-vote strategy. Essentially, the algorithm creates a large number of short equi-spaced seeds from each read, which we call subreads, that are extracted from each read. All seeds are then allowed the seeds to vote on an optical genome location. Overlapping subreads are used when read length is less than 160 bp, and more conventional alignment procedures (such as dynamic processing) are used to fill in detailed mismatch and indel information between the subreads that make up the winning voting block.</p>
<p>The MetaScope mapping workflow incorporates three functions - <code><a href="../../reference/mk_subread_index.html">mk_subread_index()</a></code>, <code><a href="../../reference/align_target.html">align_target()</a></code>, and <code>filter_r()</code>. First, we use <code><a href="../../reference/mk_subread_index.html">mk_subread_index()</a></code>, a wrapper for <code><a href="https://rdrr.io/pkg/Rsubread/man/buildindex.html" class="external-link">Rsubread::buildindex()</a></code>, to generate one or more Subread indexes from a FASTA file. To build an index, 16 bp sequences are extracted from the reference genome in every three bases, that is, there is a 2 bp gap between each pair of neighboring 16 bp sequences. Correspondingly, each read has to be scanned three times for the mapping, that is, three sets of subreads are extracted, which start from the first, second and third base of the read, respectively. A hash table is then used for a reference genome to enable fast access to the chromosomal locations of subreads extracted from each read. The index-building function provides the option of breaking the index into multiple parts so as to reduce the memory footprint (only one part is present in the memory at any time).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Code block not run</span>

<span class="fu"><a href="../../reference/mk_subread_index.html">mk_subread_index</a></span><span class="op">(</span><span class="st">'bacteria.fasta'</span><span class="op">)</span>


<span class="fu"><a href="../../reference/mk_subread_index.html">mk_subread_index</a></span><span class="op">(</span><span class="st">'archaea.fasta'</span><span class="op">)</span></code></pre></div>
<p>Following index creation, we will use the Subread aligner to map the reads to the target genome with <code><a href="../../reference/align_target.html">align_target()</a></code>. The function primarily takes as an input the location of the FASTQ file to align, which should be a text string. In practice, <code><a href="../../reference/align_target.html">align_target()</a></code> maps reads to each target library separately, removes the unmapped reads from each file, and finally merges and sorts by chromosome the BAM files from each library into a single output file. The BAM file is written automatically to the user’s working directory; the output of the function is the name of the written file. Alignment options for the underlying <code>Rsubread_align()</code> are by default sourced from the <code>align_details</code> list object; users may easily supplement their own options by supplying a new list object with list elements titled in the same manner.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Code block not run</span>

<span class="va">bacteria_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/align_target.html">align_target</a></span><span class="op">(</span><span class="va">readPath</span>, libs <span class="op">=</span> <span class="st">"bacteria"</span>,
                          project_name <span class="op">=</span> <span class="st">"bacteria_example"</span><span class="op">)</span></code></pre></div>
<p>The last step in the mapping workflow is to filter the previously outputted BAM file according to the reference genome for the filter/host species. Although we have already filtered out any unmapped reads, which may belong to one or more host species or otherwise, there may still remain some sort of unwelcome contamination in the data from the filter species, which we wish to remove. To do this, we employ <code>filter_r()</code>, which takes as input the location of the BAM file created from <code><a href="../../reference/align_target.html">align_target()</a></code>, and produces a sorted BAM file with any reads that match the filter libraries removed. We will then use this final BAM file downstream for further analysis.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Code block not run</span>

<span class="va">readPath2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"bacteria_example.bam"</span>, package <span class="op">=</span> <span class="st">"MetaScope"</span><span class="op">)</span>
<span class="va">final_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/filter_host.html">filter_host</a></span><span class="op">(</span><span class="va">readPath2</span>, libs <span class="op">=</span> <span class="st">"archaea"</span><span class="op">)</span>
<span class="co"># Produces file bacteria_example.filtered.bam</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="genome-identification">Genome Identification<a class="anchor" aria-label="anchor" href="#genome-identification"></a>
</h3>
<p>Following the proper alignment of a sample to all filter and target libraries of interest, we may proceed in identifying which genomes are most likely to be represented in the sample. This identification workflow is the core of MetaScope; it features a Bayesian read reassignment model which dramatically improves specificity and sensitivity over other methods (Francis et. al 2013). This is because such a method identifies reads with unique alignments and uses them to guide the reassignment of reads with ambiguous alignments.</p>
<p>The identification workflow consists of a single function, <code>MetaScope_ID()</code>, which reads in a .bam file, annotates the taxonomy and genome names, reduces the mapping ambiguity using a mixture model, and outputs a .csv file with the results. Currently, it assumes that the genome library/.bam files use NCBI accession names for reference names.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">MetaScope_id</span><span class="op">(</span><span class="va">final_map</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## R version 4.1.2 (2021-11-01)</span>
<span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span>
<span class="co">## Running under: CentOS Linux 7 (Core)</span>
<span class="co">## </span>
<span class="co">## Matrix products: default</span>
<span class="co">## BLAS:   /share/pkg.7/r/4.1.2/install/lib64/R/lib/libRblas.so</span>
<span class="co">## LAPACK: /share/pkg.7/r/4.1.2/install/lib64/R/lib/libRlapack.so</span>
<span class="co">## </span>
<span class="co">## locale:</span>
<span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span>
<span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span>
<span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span>
<span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span>
<span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span>
<span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span>
<span class="co">## </span>
<span class="co">## attached base packages:</span>
<span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span>
<span class="co">## </span>
<span class="co">## other attached packages:</span>
<span class="co">## [1] BiocStyle_2.20.2</span>
<span class="co">## </span>
<span class="co">## loaded via a namespace (and not attached):</span>
<span class="co">##  [1] rstudioapi_0.13     knitr_1.37          magrittr_2.0.2     </span>
<span class="co">##  [4] R6_2.5.1            ragg_1.2.1          rlang_1.0.1        </span>
<span class="co">##  [7] fastmap_1.1.0       stringr_1.4.0       tools_4.1.2        </span>
<span class="co">## [10] xfun_0.29           cli_3.2.0           jquerylib_0.1.4    </span>
<span class="co">## [13] systemfonts_1.0.3   htmltools_0.5.2     yaml_2.3.5         </span>
<span class="co">## [16] digest_0.6.29       rprojroot_2.0.2     pkgdown_2.0.2      </span>
<span class="co">## [19] crayon_1.5.0        bookdown_0.24       textshaping_0.3.6  </span>
<span class="co">## [22] BiocManager_1.30.16 purrr_0.3.4         sass_0.4.0         </span>
<span class="co">## [25] fs_1.5.2            memoise_2.0.1       cachem_1.0.6       </span>
<span class="co">## [28] evaluate_0.15       rmarkdown_2.11      stringi_1.7.6      </span>
<span class="co">## [31] compiler_4.1.2      bslib_0.3.1         desc_1.4.0         </span>
<span class="co">## [34] jsonlite_1.8.0</span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Site created by Aubrey Odom-Mabey.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
